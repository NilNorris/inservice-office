<div class="card">
    <div class="font-semibold text-xl mb-4">Historique des paiements</div>
    <p-table #dt1 [value]="payments" dataKey="id" [loading]="loading" [rowHover]="true" [showGridlines]="true">
        <ng-template #caption>
            <div class="flex justify-between items-center flex-column sm:flex-row">
                <div>
                    @if (payments && payments.length > 0) {
                    Résultat{{ payments.length>0 ? 's' : '' }}: {{ payments.length }} / {{ count }} affiché{{ payments.length>0 ? 's' :
                    '' }}
                    }
                </div>
                <div class="flex">
                    <p-button class="me-2" type="button" severity="info" (click)="toggleFilterPopOver(op2, $event)">
                        <i class="pi pi-filter"></i>
                    </p-button>
                    <p-popover #op2 id="overlay_panel" [style]="{ width: '450px' }">
                        <div class="font-semibold text-xl mb-4">Filtres</div>                       
                        <p-inputgroup >
                            <p-inputgroup-addon class="input-addon">
                                Etat
                            </p-inputgroup-addon>
                            <p-select [(ngModel)]="statusFilter" [options]="status" optionLabel="name"
                                placeholder="Selectionner" (onChange)="applyFilter()" />
                        </p-inputgroup>
                        <p-inputgroup class="mt-3">
                            <p-inputgroup-addon class="input-addon">
                                Service
                            </p-inputgroup-addon>
                            <p-select [(ngModel)]="serviceFilter" [options]="services" optionLabel="name"
                                placeholder="Selectionner" (onChange)="applyFilter()" />
                        </p-inputgroup>
                        <div class="mt-3 text-center">
                            <p-button class="mt-3" label="Annuler les filtres" severity="danger" rounded
                                (click)="resetFilter()" [disabled]="isFilterCancelable()" />
                        </div>
                    </p-popover>
                    <p-iconfield iconPosition="left" class="ml-auto">
                        <p-inputicon>
                            <i class="pi pi-search"></i>
                        </p-inputicon>
                        <input [(ngModel)]="searchFilter" pInputText type="text" placeholder="Réf / Num. Remettant"
                            (keyup)="search()" />
                    </p-iconfield>
                </div>
            </div>
        </ng-template>
        <ng-template #header>                                                                        
            <tr>
                <th>Réf. ID</th>
                <th>
                    <div class="flex justify-between items-center" (click)="sortBy('user')">
                        Client
                        <app-sort-icon [sortKey]="sortKey" field="user" [sortDir]="sortDir" />
                    </div>
                </th>
                <th>
                    <div class="flex justify-between items-center" (click)="sortBy('amount_due')">
                        Montant dûe
                        <app-sort-icon [sortKey]="sortKey" field="title" [sortDir]="sortDir" />
                    </div>
                </th>
                <th>
                    <div class="flex justify-between items-center" (click)="sortBy('service')">
                        Service
                        <app-sort-icon [sortKey]="sortKey" field="title" [sortDir]="sortDir" />
                    </div>
                </th>
                <th>
                    <div class="flex justify-between items-center" (click)="sortBy('remitter')">
                        Num. Remettant
                        <app-sort-icon [sortKey]="sortKey" field="title" [sortDir]="sortDir" />
                    </div>
                </th>
                <th>
                    <div class="flex justify-between items-center" (click)="sortBy('ref')">
                        Réf. transaction
                        <app-sort-icon [sortKey]="sortKey" field="title" [sortDir]="sortDir" />
                    </div>
                </th>
                <th>
                    <div class="flex justify-between items-center" (click)="sortBy('code')">
                        Motif
                        <app-sort-icon [sortKey]="sortKey" field="title" [sortDir]="sortDir" />
                    </div>
                </th>                
                <th>
                    <div class="flex justify-between items-center" (click)="sortBy('status')">
                       Etat
                        <app-sort-icon [sortKey]="sortKey" field="title" [sortDir]="sortDir" />
                    </div>
                </th>  
                <th>
                    <div class="flex justify-between items-center" (click)="sortBy('paid_at')">
                        Date de paiement
                        <app-sort-icon [sortKey]="sortKey" field="title" [sortDir]="sortDir" />
                    </div>
                </th> 
                <th>Action</th>
            </tr>
        </ng-template>
        <ng-template #body let-payment>
            <tr>
                <td>{{ getRef(payment.id) }}</td>
                <td>{{ payment.user.commercial_name }}</td>
                <td>{{ payment.amount_due }}ar</td>
                <td>
                    @if (getServiceLogoIcon(payment.service)) {
                       <img style="width:100px" [src]="getServiceLogoIcon(payment.service)" alt="">
                    } @else {
                        Autre
                    }                   
                </td>
                <td>{{ formatPhoneNumber(payment.remitter) }}</td>
                <td>{{ payment.ref }}</td>
                <td>{{ payment.reason }}</td>
                <td class="text-center">
                    <p-tag [value]="getStatusLabel(payment.status)" [severity]="getStatusSeverity(payment.status)"
                        class="dark:bg-surface-900!" />
                </td>
                <td>{{ payment.paid_at }}</td>
                <td>
                    <div class="flex">
                        <p-button class="me-2" icon="pi pi-eye" severity="help" outlined (click)="viewDetail(payment)" />
                    </div>
                </td>
            </tr>
        </ng-template>
        <ng-template #emptymessage>
            <tr>
                <td colspan="10">
                    <div class="text-center text-muted-color">
                        Aucune annonce
                    </div>
                </td>
            </tr>
        </ng-template>
        <ng-template #loadingbody>
            <tr>
                <td colspan="10">Chargement....</td>
            </tr>
        </ng-template>
    </p-table>
    @if (payments && payments.length < count) { <div class="h-16 mt-3 text-center">
        <p-button [loading]="loadingShowMore" label="Voir plus" severity="info" rounded (click)="showMore()" [disabled]="loadingShowMore"
            outlined="true">
        </p-button>
</div>
}
</div>
