<div class="card">
    <div class="font-semibold text-xl mb-4">Client</div>
    <p-table
        #dt1
        [value]="customers"
        dataKey="id"
        [loading]="loading"
        [rowHover]="true"
        [showGridlines]="true"
    >
        <ng-template #caption>
                    <div class="flex justify-between items-center flex-column sm:flex-row">
                        <div>
                            @if (customers.length > 0) {
                                Résultat{{ customers.length>0 ? 's' : '' }}: {{ customers.length }} / {{ count }} affiché{{ customers.length>0 ? 's' : '' }}
                            }                            
                        </div>
                        <div class="flex">
                            <p-button class="me-2" type="button" severity="info" (click)="toggleFilterPopOver(op2, $event)" >
                                <i class="pi pi-filter"></i>
                            </p-button>
                            <p-popover #op2 id="overlay_panel" [style]="{ width: '450px' }">
                                 <div class="font-semibold text-xl mb-4">Filtres</div>
                                <p-inputgroup>
                                    <p-inputgroup-addon class="input-addon">
                                        Catégorie
                                    </p-inputgroup-addon>
                                    <p-select [(ngModel)]="categoryFilter" [options]="categories" optionLabel="name" placeholder="Selectionner" (onChange)="applyFilter()" />
                                </p-inputgroup>
                                <p-inputgroup class="mt-3">
                                    <p-inputgroup-addon class="input-addon">
                                       Entité
                                    </p-inputgroup-addon >
                                    <p-select [(ngModel)]="entityFilter" [options]="entities" optionLabel="name" placeholder="Selectionner" (onChange)="applyFilter()" />
                                </p-inputgroup>
                                <p-inputgroup class="mt-3">
                                    <p-inputgroup-addon class="input-addon">
                                       Etat
                                    </p-inputgroup-addon >
                                    <p-select [(ngModel)]="statusFilter" [options]="status" optionLabel="name" placeholder="Selectionner" (onChange)="applyFilter()" />
                                </p-inputgroup>
                                <div class="mt-3 text-center">
                                    <p-button class="mt-3" label="Annuler les filtres" severity="danger" rounded (click)="resetFilter()" [disabled]="isFilterCancelable()" />
                                </div>
                            </p-popover>
                            <p-iconfield iconPosition="left" class="ml-auto">
                                <p-inputicon>
                                    <i class="pi pi-search"></i>
                                </p-inputicon>
                                <input [(ngModel)]="searchFilter" pInputText type="text" placeholder="Nom client/type service" (keyup)="applyFilter()" />
                            </p-iconfield>
                        </div>
                    </div>
                </ng-template>
        <ng-template #header>
            <tr>                            
                <th>
                    <div class="flex justify-between items-center" (click)="sortBy('commercial_name')">
                        Nom Client
                        <app-sort-icon [sortKey]="sortKey" field="commercial_name" [sortDir]="sortDir" />
                    </div>
                </th>
                <th>
                    <div class="flex justify-between items-center" (click)="sortBy('service_type')">
                        Type Service
                        <app-sort-icon [sortKey]="sortKey" field="service_type" [sortDir]="sortDir" />
                    </div>
                </th>
                <th>
                     Adresse/Ville
                </th>
                <th>
                    Catégorie
                </th>
                <th>
                    <div class="flex justify-between items-center"  (click)="sortBy('entity__label')">
                        Entité
                        <app-sort-icon [sortKey]="sortKey" field="entity__label" [sortDir]="sortDir" />
                    </div>
                </th>
                <th>Action</th>
            </tr>
        </ng-template>
        <ng-template #body let-customer>
            <tr>
                <td>{{ customer.commercial_name }}</td>
                <td>{{customer.service_type}}</td>
                <td>{{ getAddress(customer) }}</td>
                <td>
                    @if (customer.category.length>0) {
                        @for (categ of customer.category; track categ) {
                            <p-tag [value]="customer.categ" severity="success" class="dark:bg-surface-900!" />
                        }
                    } @else {
                        <p-tag value="Non renseigné" severity="warn" class="dark:bg-surface-900!" />
                    }
                </td>
                <td>
                    {{ customer.entity }}
                </td>
                <td>
                   <div class="flex">
                        <p-button class="me-2" icon="pi pi-eye" severity="help" outlined (click)="viewDetail(customer._id)" />
                        <p-button class="me-2" icon="pi pi-ban" severity="danger" outlined />
                   </div>
                </td>                
            </tr>
        </ng-template>
        <ng-template #emptymessage>
            <tr>
                <td colspan="6" >
                    <div class="text-center text-muted-color">
                        Aucun client trouvé
                    </div>
                </td>
            </tr>
        </ng-template>
        <ng-template #loadingbody>
            <tr>
                <td colspan="6">Chargement....</td>
            </tr>
        </ng-template>        
    </p-table>
    @if (customers.length < count) {
        <div class="h-16 mt-3 text-center">
            <p-button label="Voir plus" severity="info" rounded (click)="showMore()" [disabled]="loadingShowMore" outlined="true">
                @if (loading) {
                    <p-progressSpinner class="spinner" strokeWidth="6"></p-progressSpinner>  
                }
            </p-button>
        </div>
    }
</div>
